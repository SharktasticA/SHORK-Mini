#!/bin/sh

######################################################
## A small utility that changes SHORK 486's current ##
## and default keymap                               ##
######################################################
## Kali (sharktastica.co.uk)                        ##
######################################################



set -e

KEYMAPS="/usr/share/keymaps"
KEYMAP_CONF="/etc/keymap"

AVAILABLE=$(ls "$KEYMAPS"/*.kmap.bin 2>/dev/null | sed 's#.*/##; s#\.kmap.bin$##' | paste -sd '|' -)
AVAILABLE=$(echo "$AVAILABLE" | sed 's/|/ | /g')

WIDTH=$(stty size 2>/dev/null | cut -d' ' -f2)

if [ $# -ne 1 ]; then
    printf "Changes the system's keyboard layout (keymap).\n\n" | fold -s -w "$WIDTH"
    echo "Usage: shorkmap {${AVAILABLE}}" | fold -s -w "$WIDTH"
    if [ -s $KEYMAP_CONF ]; then
        CUR="$(cat $KEYMAP_CONF)"
    else
        CUR="us"
    fi
    echo "Current keymap: $CUR"
    exit 1
fi

LAYOUT="$1"
MAPFILE="$KEYMAPS/$LAYOUT.kmap.bin"

if [ ! -f "$MAPFILE" ]; then
    echo "Unknown keymap: $LAYOUT"
    echo "Available keymaps: ${AVAILABLE}"
    exit 1
fi

if ! loadkmap < "$MAPFILE"; then
    echo "ERROR: failed to load keymap: $LAYOUT"
    exit 1
fi

echo "$LAYOUT" > "$KEYMAP_CONF"
sync

echo "Applied keymap: $LAYOUT"
