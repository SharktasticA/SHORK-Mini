#!/bin/sh

######################################################
## A small utility listing main OS and hardware     ##
## specifications (NO LONGER DEVELOPED - see        ##
## https://github.com/SharktasticA/shorkfetch)      ##
######################################################
## Kali (sharktastica.co.uk)                        ##
######################################################



PCI_IDS="/usr/share/misc/pci.ids"
[ -f /usr/share/hwdata/pci.ids ] && [ ! -f "$PCI_IDS" ] && PCI_IDS="/usr/share/hwdata/pci.ids"



convert_bytes()
{
    BYTES=$1
    GIB=1073741824
    MIB=1048576
    KIB=1024

    if [ "$BYTES" -ge "$GIB" ]; then
        WHOLE=$((BYTES / GIB))
        REM=$((BYTES % GIB))
        DEC=$(((REM * 10 + GIB / 2) / GIB))

        if [ "$DEC" -eq 10 ]; then
            WHOLE=$((WHOLE + 1))
            DEC=0
        fi

        if [ "$DEC" -eq 0 ]; then
            echo "${WHOLE}GiB"
        else
            echo "${WHOLE}.${DEC}GiB"
        fi

    elif [ "$BYTES" -ge "$MIB" ]; then
        WHOLE=$((BYTES / MIB))
        REM=$((BYTES % MIB))
        DEC=$(((REM * 10 + MIB / 2) / MIB))

        if [ "$DEC" -eq 10 ]; then
            WHOLE=$((WHOLE + 1))
            DEC=0
        fi

        if [ "$DEC" -eq 0 ]; then
            echo "${WHOLE}MiB"
        else
            echo "${WHOLE}.${DEC}MiB"
        fi

    elif [ "$BYTES" -ge "$KIB" ]; then
        WHOLE=$((BYTES / KIB))
        REM=$((BYTES % KIB))
        DEC=$(((REM * 10 + KIB / 2) / KIB))

        if [ "$DEC" -eq 10 ]; then
            WHOLE=$((WHOLE + 1))
            DEC=0
        fi

        if [ "$DEC" -eq 0 ]; then
            echo "${WHOLE}KiB"
        else
            echo "${WHOLE}.${DEC}KiB"
        fi
    else
        echo "${BYTES}B"
    fi
}



# Find RAM usage and total
MEM=""
read MEM_TOTAL MEM_USED <<EOF
$(free -b | awk '/Mem:/ {print $2, $3}')
EOF
if [ -n "$MEM_TOTAL" ] && [ -n "$MEM_USED" ] && [ "$MEM_TOTAL" -gt 0 ]; then
    MEM_PCT=$((MEM_USED * 100 / MEM_TOTAL))
    MEM_TOTAL=$(convert_bytes "$MEM_TOTAL")
    MEM_USED=$(convert_bytes "$MEM_USED")
    MEM="${MEM_USED} / ${MEM_TOTAL} (${MEM_PCT}%)"
fi



# Find swap partition usage and total
SWAP=""
read SWAP_TOTAL SWAP_USED <<EOF
$(free -b | awk '/Swap:/ {print $2, $3}')
EOF
if [ -n "$SWAP_TOTAL" ] && [ -n "$SWAP_USED" ] && [ "$SWAP_TOTAL" -gt 0 ]; then
    SWAP_PCT=$((SWAP_USED * 100 / SWAP_TOTAL))
    SWAP_TOTAL=$(convert_bytes "$SWAP_TOTAL")
    SWAP_USED=$(convert_bytes "$SWAP_USED")
    SWAP="${SWAP_USED} / ${SWAP_TOTAL} (${SWAP_PCT}%)"
fi



# Find root partition usage and total
ROOT=""
read ROOT_TOTAL ROOT_USED <<EOF
$(df | awk '$NF == "/" {print $2, $3}')
EOF
if [ -n "$ROOT_TOTAL" ] && [ -n "$ROOT_USED" ]; then
    ROOT_PCT=$((ROOT_USED * 100 / ROOT_TOTAL))
    ROOT_TOTAL=$((ROOT_TOTAL * 1024))
    ROOT_USED=$((ROOT_USED * 1024))
    ROOT_TOTAL=$(convert_bytes "$ROOT_TOTAL")
    ROOT_USED=$(convert_bytes "$ROOT_USED")
    ROOT="${ROOT_USED} / ${ROOT_TOTAL} (${ROOT_PCT}%)"
fi



# Find user name
if [ -n "$USER" ]; then
    USER_NAME="$USER"
elif [ -n "$LOGNAME" ]; then
    USER_NAME="$LOGNAME"
elif [ -r /etc/passwd ]; then
    USER_NAME="$(awk -F: -v uid="$(id -u 2>/dev/null)" '$3==uid {print $1}' /etc/passwd)"
else
    USER_NAME="root"
fi

[ -z "$USER_NAME" ] && USER_NAME="root"



# Find host name
HOST_NAME="$(hostname 2>/dev/null)"
[ -z "$HOST_NAME" ] && HOST_NAME="(none)"



# Combine username and hostname for output header
HEADER="${USER_NAME}@${HOST_NAME}"



# Find OS (distro name)
if [ -r /etc/os-release ]; then
    DISTRO="$(awk -F= '/^PRETTY_NAME=/{gsub(/"/,"",$2); print $2}' /etc/os-release)"
elif [ -r /etc/issue ]; then
    DISTRO="$(head -n 1 /etc/issue | sed 's/\\.*//')"
else
    DISTRO="$(uname -o 2>/dev/null)"
fi

[ -z "$DISTRO" ] && DISTRO="unknown"



# Find kernel version
KERNEL="$(uname -r 2>/dev/null)"



# Calculate system uptime
if [ -r /proc/uptime ]; then
    SECONDS="$(awk '{print int($1)}' /proc/uptime)"
    DAYS=$(expr "$SECONDS" / 86400)
    HOURS=$(expr "$SECONDS" % 86400 / 3600)
    MINUTES=$(expr "$SECONDS" % 3600 / 60)

    [ "$DAYS" -eq 1 ] && D_UNIT="day" || D_UNIT="days"
    [ "$HOURS" -eq 1 ] && H_UNIT="hour" || H_UNIT="hours"
    [ "$MINUTES" -eq 1 ] && M_UNIT="minute" || M_UNIT="minutes"

    if [ "$DAYS" -gt 0 ]; then
        UPTIME="${DAYS} ${D_UNIT}, ${HOURS} ${H_UNIT}, ${MINUTES} ${M_UNIT}"
    else
        UPTIME="${HOURS} ${H_UNIT}, ${MINUTES} ${M_UNIT}"
    fi
else
    UPTIME="unknown"
fi



# Find shell name
if [ -n "$SHELL" ]; then
    SHELL_NAME="$(basename "$SHELL")"
elif [ -r "/proc/$$/exe" ]; then
    SHELL_NAME="$(basename "$(readlink /proc/$$/exe 2>/dev/null)")"
else
    SHELL_NAME="sh"
fi



# Find CPU name and specs
CPU_NAME="$(awk -F': ' '/model name/{print $2; exit}' /proc/cpuinfo)"
[ -z "$CPU_NAME" ] && CPU_NAME="unknown"

THREAD_COUNT="$(awk '/^processor/{c++} END{print c+0}' /proc/cpuinfo)"

CORE_COUNT="$(awk '
/^physical id/ {p[$4]=1}
/^cpu cores/   {c=$4}
END {
    if (length(p) > 0 && c > 0)
        print length(p) * c
    else
        print c+0
}' /proc/cpuinfo)"

[ "$CORE_COUNT" -eq 0 ] && CORE_COUNT="$THREAD_COUNT"
CPU_STR="${CORE_COUNT}C"
if [ "$CORE_COUNT" != "$THREAD_COUNT" ]; then
    CPU_STR="${CPU_STR}/${THREAD_COUNT}T"
fi
CPU="${CPU_NAME} (${CPU_STR})"



# Find GPU name
GPU=""
if lspci >/dev/null 2>&1 && [ -r "$PCI_IDS" ]; then
    VID=""
    DID=""

    # Find a VGA compatible controller (class 03xx) for BusyBox's lspci output style
    PCI_LINE="$(lspci 2>/dev/null | awk '$2=="Class" && substr($3,1,2)=="03" {print; exit}')"
    if [ -n "$PCI_LINE" ]; then
        VID="$(echo "$PCI_LINE" | awk '{split($4,a,":"); print a[1]}')"
        DID="$(echo "$PCI_LINE" | awk '{split($4,a,":"); print a[2]}')"
    else
        # Fallback to standard pciutils' lspci output style
        PCI_LINE="$(lspci -n | awk '$2=="0300:" { print; exit }')"
        if [ -n "$PCI_LINE" ]; then
            ID="$(echo "$PCI_LINE" | awk '{print $3}')"
            VID="${ID%%:*}"
            DID="${ID##*:}"
        fi
    fi

    VENDOR=""
    DEVICE=""

    # Find vendor and device name by querying pci.ids
    if [ -n "$VID" ] && [ -n "$DID" ]; then
        VENDOR="$(
            awk -v vid="$VID" '
                $1 == vid {
                    sub("^[0-9a-fA-F]{4}[[:space:]]+", "")
                    print
                    exit
                }
            ' "$PCI_IDS"
        )"

        DEVICE="$(
            awk -v vid="$VID" -v did="$DID" '
                $1 == vid {
                    in_vendor = 1
                    next
                }
                in_vendor && /^[0-9a-fA-F]{4}[[:space:]]/ {
                    in_vendor = 0
                }
                in_vendor && /^\t/ && $1 == did {
                    sub("^\t[0-9a-fA-F]{4}[[:space:]]+", "")
                    print
                    exit
                }
            ' "$PCI_IDS"
        )"
    fi

    if [ -n "$VENDOR" ] && [ -n "$DEVICE" ]; then
        GPU="$VENDOR $DEVICE"
    fi
fi



# Final output
printf "%s\n" "$HEADER"
printf "%s\n" "$(echo "$HEADER" | awk '{for (i=1;i<=length($0);i++) printf "-"}')"
printf "OS:      %s\n" "$DISTRO"
printf "Kernel:  %s\n" "$KERNEL"
printf "Uptime:  %s\n" "$UPTIME"
printf "Shell:   %s\n" "$SHELL_NAME"
printf "CPU:     %s\n" "$CPU"
[ -n "$GPU" ]  && printf "GPU:     %s\n" "$GPU"
[ -n "$MEM" ]  && printf "Memory:  %s\n" "$MEM"
[ -n "$SWAP" ] && printf "Swap:    %s\n" "$SWAP"
[ -n "$ROOT" ] && printf "Root:    %s\n" "$ROOT"
printf "\n"
